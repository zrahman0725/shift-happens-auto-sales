<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management - Shift Happens Auto Sales</title>
    <link rel="stylesheet" href="css/admin-inventory.css">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico?">

</head>

<body>
    <!-- Header -->
    <header class="header">
        <a href="index.html" class="logo"><img src="images/IMG-20241122-WA0003_1468205583269761 (1).png" alt="">Shift Happens Auto Sales</a>

        <i class='bx bx-menu' id="menu-icon"></i>

        <nav class="navbar">
            <a href="index.html#home" data-alt-link="home.html">Home</a>
            <div class="dropdown">
                <a href="inventory.html" data-alt-link="inventory.html">Inventory</a>
                <div class="dropdown-menu">
                    <a href="inventory.html">View Inventory</a>
                    <a href="car-finder.html">Car Finder</a>
                </div>
            </div>
            <div class="dropdown">
                <a href="finance.html" data-alt-link="finance.html">Finance</a>
                <div class="dropdown-menu">
                    <a href="finance-application.html">Finance Application</a>
                    <a href="finance.html">Finance Department</a>
                    <a href="finance.html#credit">Credit Tips</a>
                </div>
            </div>
            <div class="dropdown">
                <a href="services.html" data-alt-link="services.html">Services</a>
                <div class="dropdown-menu">
                    <a href="detailing.html">Detailing</a>
                    <a href="trade-in.html">Trade-ins</a>
                    <a href="test-drive.html">Test Drives</a>
                    <a href="car-loan.html">Loan Calculator</a>
                </div>
            </div>
            <div class="dropdown">
                <a href="about.html" data-alt-link="about.html">Dealership</a>
                <div class="dropdown-menu">
                    <a href="about.html">About Us</a>
                    <a href="index.html#contact-form">Contact</a>
                </div>
            </div>
        </nav>
        
        
    </header>

    <!-- Secondary Navbar -->
    <nav class="secondary-navbar">
        <a href="admin-dashboard.html">Dashboard</a>
        <a href="admin-inventory.html" class="active">Inventory</a>
        <a href="admin-forms.html">Forms</a>
        <a href="admin-users.html">Users</a>

    </nav>

    <!-- Inventory Section -->
    <section class="inventory" id="inventory">
        <h2 class="heading">Inventory <span>Management</span></h2>
        <div class="button-container">
            <button id="add-vehicle-btn" class="btn">Add Vehicle</button>
            <button id="add-via-vin-btn" class="btn">Add via VIN</button>
        </div>
        
        <div class="controls">
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Search by Make, Model, or Year">
            </div>
            
            
            <div class="sort-icon-container">
                <i class='bx bx-sort' id="sort-icon"></i>
            </div>
            
            <!-- Sort Popup -->
            <div id="sort-popup" class="sort-popup hidden">
                <div class="sort-popup-content">
                    <span class="close-sort-popup" id="close-sort-popup">&times;</span>
                    <h3>Sort Options</h3>
                    <div class="sort-options">
                        <label for="sort-select">Sort by:</label>
                        <select id="sort-select">
                            <option value="year-asc">Year (Ascending)</option>
                            <option value="year-desc">Year (Descending)</option>
                            <option value="price-asc">Price (Low to High)</option>
                            <option value="price-desc">Price (High to Low)</option>
                            <option value="date-added-desc">Date Added (Newest First)</option>
                            <option value="date-added-asc">Date Added (Oldest First)</option>
                            <option value="mileage-asc">Mileage (Lowest First)</option>
                            <option value="mileage-desc">Mileage (Highest First)</option>
                            <option value="make-asc">Make (A-Z)</option>
                            <option value="make-desc">Make (Z-A)</option>
                            <option value="model-asc">Model (A-Z)</option>
                            <option value="model-desc">Model (Z-A)</option>
                        </select>
                        
                        <button id="apply-sort" class="btn">Apply Sort</button>
                    </div>
                </div>
            </div>
            
            
        </div>
        
        <div id="inventory-list" class="inventory-container">
            <h3>Inventory List</h3>
            <table>
                <thead>
                    <tr>
                        <th>Picture</th>
                        <th>Make</th>
                        <th>Model</th>
                        <th>Year</th>
                        <th>Price</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Inventory items will be added dynamically -->
                </tbody>
            </table>
        </div>
    </section>

    <div id="vin-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" id="close-vin-modal">&times;</span>
            <h3>Enter VIN</h3>
            <input type="text" id="vin-input" placeholder="Enter VIN Number" required>
            <div class="button-container">
                <button id="fetch-vin-data" class="btn">Fetch Data</button>
            </div>
        </div>
    </div>
    

    <!-- Modal Popup for Adding Vehicle -->
    <div id="vehicle-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" id="close-modal">&times;</span>
            <form id="vehicle-form">
                <!-- Step 1: Vehicle Basic Information -->
                <div class="step step-1">
                    <h3>Step 1: Vehicle Basic Information</h3>
                    <input type="text" id="make" placeholder="Make" required>
                    <input type="text" id="model" placeholder="Model" required>
                    <input type="number" id="year" placeholder="Year" required>
                    <input type="number" id="price" placeholder="Price ($)" required>
                    <!-- Premium Price Toggle -->
                    <div class="toggle-container">
                        <label class="toggle-label" for="premium-toggle">Premium Price:</label>
                        <input type="checkbox" id="premium-toggle" class="toggle-checkbox">
                        <label class="toggle-slider" for="premium-toggle"></label>
                    </div>

                    <!-- Premium Price Input (Hidden by Default) -->
                    <div id="premium-price-container" class="hidden">
                        <input type="number" id="premium-price" placeholder="Premium Price ($)">
                    </div>

                    <button type="button" id="next-step-1" class="btn">Next</button>
                </div>

                <!-- Step 2: Additional Vehicle Information -->
                <div class="step step-2 hidden">
                    <h3>Step 2: Additional Vehicle Information</h3>
                    <label for="body-style">Body Style:</label>
                    <select id="body-style" required>
                        <option value="">Select Body Style</option>
                        <option value="Sedan">Sedan</option>
                        <option value="Suv">SUV / Crossover</option>
                        <option value="Pickup Truck">Pickup Truck</option>
                        <option value="Minivan">Minivan / Van</option>
                        <option value="Coupe">Coupe</option>
                        <option value="Hatchback">Hatchback</option>
                        <option value="Other">Other</option>
                    </select>

                    <label for="engine">Engine:</label>
                    <select id="engine" required>
                        <option value="">Select Engine Type</option>
                        <option value="4-cylinder">4-Cylinder</option>
                        <option value="6-cylinder">6-Cylinder</option>
                        <option value="8-cylinder">8-Cylinder</option>
                        <option value="Other">Other</option>
                    </select>

                    <label for="transmission">Transmission:</label>
                    <select id="transmission" required>
                        <option value="">Select Transmission</option>
                        <option value="Automatic">Automatic</option>
                        <option value="Manual">Manual / Standard</option>
                        <option value="Electric">Electric</option>
                        <option value="CVT">Variable / CVT</option>
                        <option value="Other">Other</option>
                    </select>

                    <label for="color">Color:</label>
                    <select id="color" required>
                        <option value="">Select Color</option>
                        <option value="White">White</option>
                        <option value="Black">Black</option>
                        <option value="Grey">Grey</option>
                        <option value="Silver">Silver</option>
                        <option value="Bronze">Bronze</option>
                        <option value="Blue">Blue</option>
                        <option value="Red">Red</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="text" id="other-color" placeholder="Specify Other Color" class="hidden">
                    <div>
                        <button type="button" id="prev-step-2" class="btn">Back</button>
                        <button type="button" id="next-step-2" class="btn">Next</button>
                    </div>
                </div>


                <div class="step step-3">
                    <h3>Step 3: Additional Vehicle Information Cont'd</h3>
                    <div>
                        <label for="fuel-type">Fuel Type:</label>
                        <select id="fuel-type" required>
                            <option value="" disabled selected>Select Fuel Type</option>
                            <option value="Gasoline">Gasoline</option>
                            <option value="Diesel">Diesel</option>
                            <option value="Electric">Electric</option>
                            <option value="Hybrid">Hybrid</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="drive-train">Drive Train:</label>
                        <select id="drive-train" required>
                            <option value="" disabled selected>Select Drive Train</option>
                            <option value="FWD">Front-Wheel Drive (FWD)</option>
                            <option value="RWD">Rear-Wheel Drive (RWD)</option>
                            <option value="AWD">All-Wheel Drive (AWD)</option>
                            <option value="4WD">Four-Wheel Drive (4WD)</option>
                            <option value="Other">Other</option>

                        </select>
                    </div>
                    <div>
                        <label for="doors">Doors:</label>
                        <input type="number" id="doors" placeholder="Number of Doors" required>
                    </div>
                    <div>
                        <label for="seats">Seats:</label>
                        <input type="number" id="seats" placeholder="Number of Seats" required>
                    </div>
                    <div>
                        <label for="interior-color">Interior Color:</label>
                        <select id="interior-color" required>
                            <option value="" disabled selected>Select Interior Color</option>
                            <option value="Black">Black</option>
                            <option value="Gray">Gray</option>
                            <option value="Beige">Beige</option>
                            <option value="White">White</option>
                            <option value="Red">Red</option>
                            <option value="Brown">Brown</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <button type="button" id="prev-step-3" class="btn">Back</button>
                        <button type="button" id="next-step-3" class="btn">Next</button>
                    </div>
                </div>


                <!-- Step 4: Vehicle Identification -->
                <div class="step step-4 hidden">
                    <h3>Step 4: Vehicle Identification</h3>
                    <label for="mileage">Mileage (in kms):</label>
                    <input type="number" id="mileage" placeholder="Enter mileage" required>

                    <label for="vin">VIN Number:</label>
                    <input type="text" id="vin" placeholder="Enter VIN" required>

                    <label for="stock">Stock #:</label>
                    <input type="text" id="stock" placeholder="Enter Stock #" required>
                    <div>
                        <button type="button" id="prev-step-4" class="btn">Back</button>
                        <button type="button" id="next-step-4" class="btn">Next</button>
                    </div>
                </div>

                <!-- Step 5: Vehicle Description -->
                <div class="step step-5 hidden">
                    <h3>Step 5: Vehicle Description</h3>
                    <label for="description">Vehicle Description:</label>
                    <textarea id="description" placeholder="Enter vehicle description" rows="5"></textarea>

                    <!-- Toggle for AI-generated description -->
                    <div class="toggle-container">
                        <label class="toggle-label" for="ai-description-toggle">Automatically Generate AI Description:</label>
                        <input type="checkbox" id="ai-description-toggle" class="toggle-checkbox">
                        <label class="toggle-slider" for="ai-description-toggle"></label>
                    </div>

                    <div>
                        <button type="button" id="prev-step-5" class="btn">Back</button>
                        <button type="button" id="next-step-5" class="btn">Next</button>
                    </div>
                </div>

                <!-- Step 6: Media Upload -->
                <div class="step step-6 hidden">
                    <h3>Step 6: Media Upload</h3>

                        <!-- Existing Media Display -->
                        <div id="existing-media">
                            <!-- Existing media links will be populated dynamically -->
                        </div>

                    <label for="main-picture">Main Picture (Required):</label>
                    <input type="file" id="main-picture" accept="image/*" required>

                    <label for="secondary-pictures">Secondary Pictures (Optional):</label>
                    <input type="file" id="secondary-pictures" accept="image/*" multiple>
                    <div>
                        <button type="button" id="prev-step-6" class="btn">Back</button>
                        <button type="submit" class="btn">Save Vehicle</button>
                    </div>
                </div>
            </form>
        </div>
    </div>



    <!-- Delete Confirmation Modal -->
    <div id="delete-confirmation-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Are you sure you want to delete this vehicle?</h3>
            <p>This action is irreversible.</p>
            <div class="button-container">
                <button id="cancel-delete" class="btn cancel-btn">Cancel</button>
                <button id="confirm-delete" class="btn confirm-btn">Confirm</button>
            </div>
        </div>
    </div>


    <div id="loading-spinner" class="hidden">
        <div class="spinner"></div>
        <p>Uploading images, please wait...</p>
    </div>



    <!-- Footer -->
    <footer class="footer">
        <div class="footer-text">
            <p>Copyright &copy; 2024 by Shift Happens Auto Sales | All Rights Reserved. | <a href="admin-login.html">Admin</a></p>
        </div>
        <div class="footer-iconTop">
            <a href="#"><i class='bx bx-up-arrow-alt'></i></a>
        </div>
    </footer>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";

        import {
            getFirestore,
            collection,
            query,
            orderBy,
            addDoc,
            getDocs,
            onSnapshot,
            doc,
            deleteDoc,
            updateDoc



        } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
    
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDv6Jkk-7XqeCMTy14Fjs_upMAjVM7uNVg",
            authDomain: "shift-happens-auto-sales.firebaseapp.com",
            projectId: "shift-happens-auto-sales",
            storageBucket: "shift-happens-auto-sales.firebasestorage.app",
            messagingSenderId: "224158026936",
            appId: "1:224158026936:web:690dd13405f6b1bfc4b84d",
            measurementId: "G-09D7MLNSNS"
        };




        let currentEditData = null;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const inventoryRef = collection(db, "inventory");
        const vinModal = document.getElementById('vin-modal');
        const closeVinModal = document.getElementById('close-vin-modal');
        const fetchVinDataBtn = document.getElementById('fetch-vin-data');
        const vinInput = document.getElementById('vin-input');
        const addViaVinBtn = document.getElementById('add-via-vin-btn');
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "admin-login.html";
            }
        });

        function resetVinModal() {
            // Clear the VIN input field
            document.getElementById('vin-input').value = '';

            // Hide any error messages or feedback (if applicable)
            const errorMessage = document.getElementById('vin-error-message');
            if (errorMessage) {
                errorMessage.textContent = '';
            }

            // Reset any other modal-specific elements or states (if needed)
            // Example: Clear dropdowns or selections in the modal
            const dropdowns = document.querySelectorAll('#vin-modal select');
                dropdowns.forEach(dropdown => {
                    dropdown.selectedIndex = 0;
                });
        }


        function resetPremiumPriceField() {
            const premiumToggle = document.getElementById('premium-toggle');
            const premiumPriceContainer = document.getElementById('premium-price-container');
            const premiumPriceInput = document.getElementById('premium-price');

            // Reset toggle and field visibility
            premiumToggle.checked = false;
            premiumPriceContainer.classList.add('hidden');
            premiumPriceInput.value = '';
            premiumPriceInput.removeAttribute('required');
        }

        // Open VIN Modal
        addViaVinBtn.addEventListener('click', () => {
            vinModal.classList.remove('hidden');
        });

        // Close VIN Modal
        closeVinModal.addEventListener('click', () => {
            vinModal.classList.add('hidden');
            resetVinModal(); // Reset the modal state
            resetPremiumPriceField();

        });


        // Function to reset all fields in the modal
        function resetVehicleModal() {
            const modalForm = document.getElementById('vehicle-form');
            if (modalForm) {
                modalForm.reset(); // Reset all input fields
            }

            // Reset specific states
            document.getElementById('premium-toggle').checked = false;
            document.getElementById('premium-price-container').classList.add('hidden');
            document.getElementById('premium-price').value = '';
            document.getElementById('description').value = '';
            document.getElementById('existing-media').innerHTML = ''; // Clear media
            document.getElementById('main-picture').value = '';
            document.getElementById('secondary-pictures').value = '';

            // Hide "Other Color" field if visible
            const otherColorField = document.getElementById('other-color');
            if (otherColorField) {
                otherColorField.classList.add('hidden');
                otherColorField.value = '';
            }

            // Reset all dropdowns to their default value
            const dropdowns = modalForm.querySelectorAll('select');
            dropdowns.forEach(dropdown => {
                dropdown.selectedIndex = 0;
            });
        }

        // Add event listener for modal close button
        document.getElementById('close-modal').addEventListener('click', () => {
            resetVehicleModal();
            resetPremiumPriceField(); // Reset premium price field
            document.getElementById('vehicle-modal').classList.add('hidden'); // Hide modal
        });

        // Add event listener for VIN modal close button
        document.getElementById('close-vin-modal').addEventListener('click', () => {
            resetVinModal(); // This is already defined in your code
            document.getElementById('vin-modal').classList.add('hidden'); // Hide VIN modal
        });


        fetchVinDataBtn.addEventListener('click', async () => {
            const vin = vinInput.value.trim();
            currentEditData = null; // Reset any existing data
            currentEditId = null; // Ensure this is a new entry

            if (!vin) {
                alert('Please enter a VIN number.');
                return;
            }

            try {
                const response = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/${vin}?format=json`);
                const data = await response.json();

                if (data && data.Results && data.Results.length > 0) {
                    const vehicleData = data.Results[0];

                    // Pre-fill the form
                    document.getElementById('make').value = formatMake(vehicleData.Make || ''); // Format Make
                    document.getElementById('model').value = vehicleData.Model || ''; // Model
                    document.getElementById('year').value = vehicleData.ModelYear || ''; // Year
                    document.getElementById('vin').value = vin || ''; // VIN
                    function formatMake(make) {
                        if (!make) return '';
                        return make.charAt(0).toUpperCase() + make.slice(1).toLowerCase();
                    }
                    // Dropdown prefill logic
                    selectDropdownOption('body-style', vehicleData.BodyClass || ''); // Body Style
                    selectDropdownOption('transmission', vehicleData.TransmissionStyle || ''); // Transmission
                    selectDropdownOption('fuel-type', vehicleData.FuelTypePrimary || ''); // Fuel Type
                    selectDropdownOption('drive-train', vehicleData.DriveType || ''); // Drive Train
                    selectDropdownOption('engine', vehicleData.EngineCylinders || ''); // Engine Cylinders

                    // Direct field assignments for non-dropdowns
                    document.getElementById('doors').value = vehicleData.Doors || ''; // Number of Doors
                    document.getElementById('seats').value = vehicleData.Seats || ''; // Seats

                    // Categorize features
                    const categorizedFeatures = categorizeFeatures(vehicleData);

                    // Save features globally to include in vehicleData
                    window.vehicleFeatures = categorizedFeatures; // Temporary storage
     

                    // Hide VIN Modal and Show Form
                    vinModal.classList.add('hidden');
                    modal.classList.remove('hidden');
                    currentStep = 0;
                    updateSteps();

                } else {
                    alert('No data found for the provided VIN.');
                }
            } catch (error) {
                console.error('Error fetching VIN data:', error);
                alert('Failed to fetch vehicle data. Please try again.');
            }
        });
        function categorizeFeatures(vehicleData) {
    return {
        Mechanical: {
            Engine: vehicleData.EngineCylinders || 'N/A',
            Transmission: vehicleData.TransmissionStyle || 'N/A',
            FuelType: vehicleData.FuelTypePrimary || 'N/A',
            DriveTrain: vehicleData.DriveType || 'N/A',
            EngineConfiguration: vehicleData.EngineConfiguration || 'N/A',
            EngineModel: vehicleData.EngineModel || 'N/A',
            EnginePowerKW: vehicleData.EngineKW || 'N/A',
            EngineHP: vehicleData.EngineHP || 'N/A',
            DisplacementCC: vehicleData.DisplacementCC || 'N/A',
            DisplacementCI: vehicleData.DisplacementCI || 'N/A',
            DisplacementL: vehicleData.DisplacementL || 'N/A',
            Axles: vehicleData.Axles || 'N/A',
            BrakeSystemType: vehicleData.BrakeSystemType || 'N/A',
            BrakeSystemDesc: vehicleData.BrakeSystemDesc || 'N/A',
            CoolingType: vehicleData.CoolingType || 'N/A',
            Turbo: vehicleData.Turbo || 'N/A',
        },
        Safety: {
            ABS: vehicleData.ABS || 'N/A',
            AirBagLocFront: vehicleData.AirBagLocFront || 'N/A',
            AirBagLocCurtain: vehicleData.AirBagLocCurtain || 'N/A',
            AirBagLocKnee: vehicleData.AirBagLocKnee || 'N/A',
            AirBagLocSide: vehicleData.AirBagLocSide || 'N/A',
            ESC: vehicleData.ESC || 'N/A',
            TractionControl: vehicleData.TractionControl || 'N/A',
            ForwardCollisionWarning: vehicleData.ForwardCollisionWarning || 'N/A',
            LaneDepartureWarning: vehicleData.LaneDepartureWarning || 'N/A',
            LaneKeepSystem: vehicleData.LaneKeepSystem || 'N/A',
            RearVisibilitySystem: vehicleData.RearVisibilitySystem || 'N/A',
            ParkAssist: vehicleData.ParkAssist || 'N/A',
            BlindSpotMon: vehicleData.BlindSpotMon || 'N/A',
            BlindSpotIntervention: vehicleData.BlindSpotIntervention || 'N/A',
            RearAutomaticEmergencyBraking: vehicleData.RearAutomaticEmergencyBraking || 'N/A',
            PedestrianAutomaticEmergencyBraking: vehicleData.PedestrianAutomaticEmergencyBraking || 'N/A',
            AutoReverseSystem: vehicleData.AutoReverseSystem || 'N/A',
            DynamicBrakeSupport: vehicleData.DynamicBrakeSupport || 'N/A',
        },
        Exterior: {
            BodyStyle: vehicleData.BodyClass || 'N/A',
            Color: vehicleData.ExteriorColor || 'N/A',
            WheelBaseType: vehicleData.WheelBaseType || 'N/A',
            WheelBaseShort: vehicleData.WheelBaseShort || 'N/A',
            WheelBaseLong: vehicleData.WheelBaseLong || 'N/A',
            Length: vehicleData.VehicleLength || 'N/A',
            Width: vehicleData.VehicleWidth || 'N/A',
            Height: vehicleData.VehicleHeight || 'N/A',
            Wheels: vehicleData.Wheels || 'N/A',
            WheelSizeFront: vehicleData.WheelSizeFront || 'N/A',
            WheelSizeRear: vehicleData.WheelSizeRear || 'N/A',
            DaytimeRunningLight: vehicleData.DaytimeRunningLight || 'N/A',
            LowerBeamHeadlampLightSource: vehicleData.LowerBeamHeadlampLightSource || 'N/A',
            HeadlampBeamSwitching: vehicleData.SemiautomaticHeadlampBeamSwitching || 'N/A',
            AdaptiveHeadlights: vehicleData.AdaptiveHeadlights || 'N/A',
        },
        Interior: {
            Seats: vehicleData.Seats || 'N/A',
            SeatRows: vehicleData.SeatRows || 'N/A',
            SeatBeltsAll: vehicleData.SeatBeltsAll || 'N/A',
            InteriorColor: vehicleData.InteriorColor || 'N/A',
            Trim: vehicleData.Trim || 'N/A',
            Trim2: vehicleData.Trim2 || 'N/A',
            CabinType: vehicleData.CabinType || 'N/A',
            SteeringLocation: vehicleData.SteeringLocation || 'N/A',
            KeylessIgnition: vehicleData.KeylessIgnition || 'N/A',
        },
        Entertainment: {
            InfotainmentSystem: vehicleData.EntertainmentSystem || 'N/A',
            Speakers: vehicleData.Audio || 'N/A',
            NavigationSystem: vehicleData.NavigationSystem || 'N/A',
        },
        Additional: {
            VIN: vehicleData.VIN || 'N/A',
            Make: vehicleData.Make || 'N/A',
            Model: vehicleData.Model || 'N/A',
            ModelYear: vehicleData.ModelYear || 'N/A',
            Manufacturer: vehicleData.Manufacturer || 'N/A',
            PlantCity: vehicleData.PlantCity || 'N/A',
            PlantState: vehicleData.PlantState || 'N/A',
            PlantCountry: vehicleData.PlantCountry || 'N/A',
            PlantCompanyName: vehicleData.PlantCompanyName || 'N/A',
            GVWR: vehicleData.GVWR || 'N/A',
            Series: vehicleData.Series || 'N/A',
            Series2: vehicleData.Series2 || 'N/A',
            EngineManufacturer: vehicleData.EngineManufacturer || 'N/A',
            BasePrice: vehicleData.BasePrice || 'N/A',
            TopSpeedMPH: vehicleData.TopSpeedMPH || 'N/A',
            ErrorCode: vehicleData.ErrorCode || 'N/A',
            ErrorText: vehicleData.ErrorText || 'N/A',
        }
    };
}



        function selectDropdownOption(dropdownId, value) {
            const dropdown = document.getElementById(dropdownId);
            const options = dropdown.options;

            if (!value) {
                dropdown.selectedIndex = 0; // Default to the first option
                return;
            }

            // Normalize the value to a string
            const normalizedValue = value.toString().toLowerCase();

            // Define synonyms and simplified mappings
            const synonyms = {
            // Body Style Synonyms
            "sport utility vehicle": "suv",
            "multi-purpose vehicle": "crossover",
            "compact car": "sedan",
            "ev": "electric",
            "sedan/saloon": "sedan",
            "pickup truck": "pickup",
            "minivan/van": "minivan",
            "van": "minivan",
            "coupe": "coupe",
            "hatchback": "hatchback",
            "convertible": "convertible",
            "wagon": "wagon",
            "mpv": "crossover",
            "suv": "suv",

            // Engine Synonyms
            "4": "4-cylinder",
            "6": "6-cylinder",
            "8": "8-cylinder",

            // Drive Type Synonyms
            "fwd": "front-wheel drive",
            "4x2": "front-wheel drive",
            "front-wheel drive": "front-wheel drive",
            "rwd": "rear-wheel drive",
            "rear-wheel drive": "rear-wheel drive",
            "awd": "all-wheel drive",
            "all-wheel drive": "all-wheel drive",
            "4wd": "four-wheel drive",
            "four-wheel drive": "four-wheel drive",

            // Transmission Synonyms
            "automatic": "automatic",
            "manual": "manual",
            "stick shift": "manual",
            "auto": "automatic",
            "cvti-s": "cvt",
            "cvt": "cvt",
            "continuously variable transmission": "cvt",
            "dual-clutch": "other",
            "dct": "other",
            "semi-automatic": "other",
            "tiptronic": "other",
            "e-shift": "other",
            "am": "other",
            "automated manual": "other",
            "sequential": "other",
            "smg": "other",
            "torque converter": "automatic",
            "shiftable automatic": "automatic",
            "geartronic": "automatic"



        };


            // Replace synonyms in the value
            let mappedValue = normalizedValue;
            for (const [key, synonym] of Object.entries(synonyms)) {
                if (mappedValue.includes(key)) {
                    mappedValue = synonym;
                    break;
                }
            }

            // Match the mapped value to the dropdown options
            for (let i = 0; i < options.length; i++) {
                const optionText = options[i].text.toLowerCase();

                if (optionText.includes(mappedValue) || mappedValue.includes(optionText)) {
                    dropdown.selectedIndex = i;
                    return;
                }
            }

            dropdown.selectedIndex = 0; // Default if no match
        }




        

        // Integrate the new sorting code here
        document.getElementById("apply-sort").addEventListener("click", async () => {
            const sortSelect = document.getElementById("sort-select");
            const selectedOption = sortSelect.value;

            let field = "year"; // Default field
            let direction = "asc"; // Default direction

            switch (selectedOption) {
                case "year-asc":
                    field = "year";
                    direction = "asc";
                    break;
                case "year-desc":
                    field = "year";
                    direction = "desc";
                    break;
                case "price-asc":
                    field = "price";
                    direction = "asc";
                    break;
                case "price-desc":
                    field = "price";
                    direction = "desc";
                    break;
                case "date-added-desc":
                    field = "timestamp"; // Assumes Firestore has a 'timestamp' field for date added
                    direction = "desc";
                    break;
                case "date-added-asc":
                    field = "timestamp";
                    direction = "asc";
                    break;
                case "mileage-asc":
                    field = "mileage";
                    direction = "asc";
                    break;
                case "mileage-desc":
                    field = "mileage";
                    direction = "desc";
                    break;
                case "make-asc":
                    field = "make";
                    direction = "asc";
                    break;
                case "make-desc":
                    field = "make";
                    direction = "desc";
                    break;
                case "model-asc":
                    field = "model";
                    direction = "asc";
                    break;
                case "model-desc":
                    field = "model";
                    direction = "desc";
                    break;
            }

            try {
                // Fetch sorted data from Firestore
                const querySnapshot = await getDocs(query(inventoryRef, orderBy(field, direction)));

                const inventoryTableBody = document.querySelector("#inventory-list tbody");
                inventoryTableBody.innerHTML = ""; // Clear the existing table

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const row = document.createElement("tr");

                    row.innerHTML = `
                        <td><img src="${data.mainPictureUrl}" alt="${data.make} ${data.model}" class="table-picture"></td>
                        <td>${data.make}</td>
                        <td>${data.model}</td>
                        <td>${data.year}</td>
                        <td>$${data.price}</td>
                        <td>
                            <div class="action-dropdown">
                                <button class="btn action-btn">Actions &#9662;</button>
                                <div class="action-menu hidden">
                                    <a class="action-item edit-action">Edit</a>
                                    <a class="action-item sold-action">Mark as Sold</a>
                                    <a class="action-item delete-action">Delete</a>
                                </div>
                            </div>
                        </td>
                    `;

                    inventoryTableBody.appendChild(row);
                    attachActionListeners(row, doc.id, data);
                });

                document.getElementById("sort-popup").classList.add("hidden"); // Close the popup
            } catch (error) {
                console.error("Error fetching sorted data:", error);
                alert("Failed to sort inventory. Please try again.");
            }
        });

        function attachActionListeners(row, docId, data) {
            const dropdownBtn = row.querySelector(".action-btn");
            const actionMenu = row.querySelector(".action-menu");

            dropdownBtn.addEventListener("click", (event) => {
                event.stopPropagation();
                actionMenu.classList.toggle("hidden");
                closeOtherDropdowns(actionMenu);
            });

            const editAction = row.querySelector(".edit-action");
            const deleteAction = row.querySelector(".delete-action");
            const soldAction = row.querySelector(".sold-action");

            editAction.addEventListener("click", () => editVehicle(data, docId));
            deleteAction.addEventListener("click", () => openDeleteConfirmationModal(docId));
            soldAction.addEventListener("click", () => openMarkAsSoldModal(docId, data));
        }


        const aiDescriptionToggle = document.getElementById("ai-description-toggle");
        const descriptionTextarea = document.getElementById("description");

        // async function generateAIText({ year, make, model }) {
        //     const prompt = `Write a detailed and attractive description about a ${year} ${make} ${model}. Keep it descriptive but short, under 150 words.`;

        //     try {
        //         const response = await fetch("https://api.cohere.ai/generate", {
        //             method: "POST",
        //             headers: {
        //                 "Content-Type": "application/json",
        //                 Authorization: `op5S2EhgqivJcRXMXxQzdmWSeZ1euyrkgRVPC9sO`,
        //             },
        //             body: JSON.stringify({
        //                 model: "command-xlarge-nightly",
        //                 prompt: prompt,
        //                 max_tokens: 300,
        //                 temperature: 0.7,
        //             }),
        //         });

        //         const data = await response.json();

        //         if (data.generations && data.generations.length > 0) {
        //             return data.generations[0].text.trim();
        //         } else {
        //             throw new Error("No valid response from AI");
        //         }
        //     } catch (error) {
        //         console.error("Error calling Cohere API:", error);
        //         throw error;
        //     }
        // }


        // Listen for changes in the AI Description toggle
        aiDescriptionToggle.addEventListener("change", async () => {
            if (aiDescriptionToggle.checked) {
                const make = document.getElementById('make').value.trim();
                const model = document.getElementById('model').value.trim();
                const year = document.getElementById('year').value.trim();

                if (!make || !model || !year) {
                    alert("Please fill in the Year, Make, and Model fields before generating a description.");
                    aiDescriptionToggle.checked = false;
                    return;
                }

                try {
                    descriptionTextarea.value = "Generating description...";
                    descriptionTextarea.setAttribute('readonly', 'true'); // Prevent user edits during generation

                    // Call the AI API to generate the description
                    const description = await generateAIText({ year, make, model });function resetPremiumPriceField() {
                        const premiumToggle = document.getElementById('premium-toggle');
                        const premiumPriceContainer = document.getElementById('premium-price-container');
                        const premiumPriceInput = document.getElementById('premium-price');

                        // Reset toggle and field visibility
                        premiumToggle.checked = false;
                        premiumPriceContainer.classList.add('hidden');
                        premiumPriceInput.value = '';
                        premiumPriceInput.removeAttribute('required');
                    }


                    // Update the description field
                    descriptionTextarea.value = description;
                } catch (error) {
                    console.error("Error generating AI description:", error);
                    alert("Failed to generate description. The toggle will be turned off.");
                    descriptionTextarea.value = ""; // Clear the field if generation fails
                    aiDescriptionToggle.checked = false; // Turn off the toggle
                } finally {
                    descriptionTextarea.removeAttribute('readonly'); // Allow user edits
                }
            } else {
                // Clear the description field and make it editable
                descriptionTextarea.value = "";
                descriptionTextarea.removeAttribute('readonly');
            }
        });


        // Elements
        const modal = document.getElementById('vehicle-modal');
        const form = document.getElementById('vehicle-form');
        const premiumToggle = document.getElementById('premium-toggle');
        const premiumPriceContainer = document.getElementById('premium-price-container');
        const premiumPriceInput = document.getElementById('premium-price');
        const deleteConfirmationModal = document.getElementById('delete-confirmation-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        const steps = document.querySelectorAll('.step');
        const addVehicleBtn = document.getElementById('add-vehicle-btn');
        const closeModalBtn = document.getElementById('close-modal');
    
        let currentStep = 0;
        let mode = "add";
        let currentEditId = null;
        let vehicleToDeleteId = null;
    
        // Show/Hide Loading Spinner
        function showLoading() {
            document.getElementById('loading-spinner').classList.remove('hidden');
        }
    
        function hideLoading() {
            document.getElementById('loading-spinner').classList.add('hidden');
        }
    
        // Premium Price Toggle
        premiumToggle.addEventListener('change', () => {
            if (premiumToggle.checked) {
                premiumPriceContainer.classList.remove('hidden');
                premiumPriceInput.setAttribute('required', 'true');
            } else {
                premiumPriceContainer.classList.add('hidden');
                premiumPriceInput.removeAttribute('required');
                premiumPriceInput.value = '';
            }
        });
    
        // Multi-Step Form Navigation
        const nextButtons = document.querySelectorAll('[id^=next-step]');
        const prevButtons = document.querySelectorAll('[id^=prev-step]');
    
        nextButtons.forEach((btn) => {
            btn.addEventListener('click', () => {
                if (validateCurrentStep()) {
                    if (currentStep < steps.length - 1) {
                        currentStep++;
                        updateSteps();
                    }
                }
            });
        });
    
        prevButtons.forEach((btn) => {
            btn.addEventListener('click', () => {
                if (currentStep > 0) {
                    currentStep--;
                    updateSteps();
                }
            });
        });
    
        function updateSteps() {
            steps.forEach((step, index) => {
                step.classList.toggle('hidden', index !== currentStep);
            });
        }
    
        // Add Vehicle
        addVehicleBtn.addEventListener('click', () => {
            mode = "add";
            currentEditId = null;
            currentEditData = null; // Clear leftover edit data
            currentStep = 0;
            updateSteps();
            form.reset();
            modal.classList.remove('hidden');

            // Reset Premium Price Toggle
            premiumToggle.checked = false; // Ensure the toggle is unchecked
            premiumPriceContainer.classList.add('hidden'); // Hide the premium price field
            premiumPriceInput.value = ''; // Clear the premium price value
            premiumPriceInput.removeAttribute('required'); // Ensure it's not marked as required
            
            // Reset specific fields
            document.getElementById('description').value = '';
            const existingMediaContainer = document.getElementById('existing-media');
            existingMediaContainer.innerHTML = ''; // Clear any media from previous entries
            document.getElementById('main-picture').value = '';
            document.getElementById('secondary-pictures').value = '';
        });
    
        closeModalBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
        });
    
        // Populate Inventory Table
        function populateInventoryTable() {
            const inventoryTableBody = document.querySelector('#inventory-list tbody');
            inventoryTableBody.innerHTML = "";
    
            onSnapshot(inventoryRef, (snapshot) => {
                inventoryTableBody.innerHTML = "";
    
                snapshot.docs.forEach((doc) => {
                    const data = doc.data();
    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><img src="${data.mainPictureUrl}" alt="${data.make} ${data.model}" class="table-picture"></td>
                        <td>${data.make}</td>
                        <td>${data.model}</td>
                        <td>${data.year}</td>
                        <td>$${data.price}</td>
                        <td>
                            <div class="action-dropdown">
                                <button class="btn action-btn">Actions &#9662;</button>
                                <div class="action-menu hidden">
                                    <a class="action-item edit-action">Edit</a>
                                    <a class="action-item sold-action">Mark as Sold</a>
                                    <a class="action-item delete-action">Delete</a>
                                </div>
                            </div>
                        </td>

                    `;
    
                    inventoryTableBody.appendChild(row);

                    // Add Event Listeners for Dropdown Actions
                    const dropdownBtn = row.querySelector('.action-btn');
                    const actionMenu = row.querySelector('.action-menu');

                    // Toggle Dropdown Visibility
                    dropdownBtn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        actionMenu.classList.toggle('hidden');
                        closeOtherDropdowns(actionMenu);
                    });

                    // Add Action Handlers
                    const editAction = row.querySelector('.edit-action');
                    const deleteAction = row.querySelector('.delete-action');
                    const soldAction = row.querySelector('.sold-action');

                    editAction.addEventListener('click', () => editVehicle(data, doc.id));
                    deleteAction.addEventListener('click', () => openDeleteConfirmationModal(doc.id));
                    soldAction.addEventListener('click', () => openMarkAsSoldModal(doc.id, data));
                });
            });
        }

        // Close Other Dropdowns
        function closeOtherDropdowns(openMenu) {
            document.querySelectorAll('.action-menu').forEach((menu) => {
                if (menu !== openMenu) {
                    menu.classList.add('hidden');
                }
            });
        }

        // Hide All Dropdowns on Outside Click
        document.addEventListener('click', () => {
            document.querySelectorAll('.action-menu').forEach((menu) => {
                menu.classList.add('hidden');
            });
        });
    
        document.querySelectorAll('input, select, textarea').forEach((field) => {
            field.addEventListener('input', () => {
                if (field.value.trim()) {
                    field.classList.remove('error');
                }
            });
        });
    
    
        // Edit Vehicle
        function editVehicle(data, id) {
            mode = "edit";
            currentEditId = id;

            // Ensure data consistency
            currentEditData = {
                ...data,
                secondaryPicturesUrls: data.secondaryPicturesUrls || [], // Always default to an empty array
            };

            currentStep = 0;
            updateSteps();
            modal.classList.remove('hidden');

            // Step 1: Basic Information
            document.getElementById('make').value = data.make || '';
            document.getElementById('model').value = data.model || '';
            document.getElementById('year').value = data.year || '';
            document.getElementById('price').value = data.price || '';

            // Premium Price Toggle
            if (data.premiumPrice) {
                premiumToggle.checked = true;
                premiumPriceContainer.classList.remove('hidden');
                premiumPriceInput.value = data.premiumPrice || '';
            } else {
                premiumToggle.checked = false;
                premiumPriceContainer.classList.add('hidden');
                premiumPriceInput.value = '';
            }

            // Step 2: Additional Vehicle Information
            document.getElementById('body-style').value = data.bodyStyle || '';
            document.getElementById('engine').value = data.engine || '';
            document.getElementById('transmission').value = data.transmission || '';
            document.getElementById('color').value = data.color || '';

            // Show "Other Color" field if applicable
            const otherColorInput = document.getElementById('other-color');
            if (data.color === 'other') {
                otherColorInput.classList.remove('hidden');
                otherColorInput.value = data.otherColor || '';
            } else {
                otherColorInput.classList.add('hidden');
                otherColorInput.value = '';
            }

            // Step 3: More Vehicle Information
            document.getElementById('fuel-type').value = data.fuelType || '';
            document.getElementById('drive-train').value = data.driveTrain || '';
            document.getElementById('doors').value = data.doors || '';
            document.getElementById('seats').value = data.seats || '';

            // Step 4: Fuel Consumption
            document.getElementById('interior-color').value = data.interiorColor || '';


            // Step 5: Vehicle Identification
            document.getElementById('mileage').value = data.mileage || '';
            document.getElementById('vin').value = data.vin || '';
            document.getElementById('stock').value = data.stock || '';

            // Step 6: Vehicle Description
            document.getElementById('description').value = data.description || '';

            // Step 7: Media Upload

            const mainPictureInput = document.getElementById('main-picture');
            mainPictureInput.value = ''; // Clear the file input
            mainPictureInput.removeAttribute('required'); // Remove the `required` attribute during edit
            
            const existingMediaContainer = document.getElementById('existing-media');
            existingMediaContainer.innerHTML = ''; // Clear any existing media items

            // Main Picture
            if (data.mainPictureUrl) {
                const mainMediaItem = createMediaItem(data.mainPictureUrl, true);
                existingMediaContainer.appendChild(mainMediaItem);
            }

            // Secondary Pictures
            (data.secondaryPicturesUrls || []).forEach((url) => {
                const mediaItem = createMediaItem(url, false);
                existingMediaContainer.appendChild(mediaItem);
            });
        }


        // Helper Function to Create Media Items
        function createMediaItem(url, isMain) {
            const mediaItem = document.createElement('div');
            mediaItem.classList.add('media-item');
            mediaItem.innerHTML = `
                <img src="${url}" alt="Media" class="media-thumbnail">
                <span>${isMain ? 'Main Picture' : 'Secondary Picture'}</span>
                <button class="remove-media-btn" data-url="${url}">X</button>
            `;

            // Remove Media Button
            mediaItem.querySelector('.remove-media-btn').addEventListener('click', (e) => {
                e.preventDefault();
                mediaItem.remove(); // Remove the item from the DOM

                if (isMain) {
                    // For main picture, alert user and reset
                    currentEditData.mainPictureUrl = null;
                } else {
                    // For secondary pictures, remove the URL from secondaryPicturesUrls
                    currentEditData.secondaryPicturesUrls = currentEditData.secondaryPicturesUrls.filter(
                        (existingUrl) => existingUrl !== url
                    );
                }
            });

            return mediaItem;
        }

        function validateCurrentStep() {
            const currentStepElement = steps[currentStep];
            const inputs = currentStepElement.querySelectorAll('[required]');
            let isValid = true;

            inputs.forEach((input) => {
                if (!input.value.trim()) {
                    isValid = false;
                    input.classList.add('error');
                } else {
                    input.classList.remove('error');
                }
            });

            if (!isValid) {
            }

            return isValid;
        }


    

        // Add Mark as Sold Modal Elements
        const soldModal = document.createElement("div");
        soldModal.id = "sold-modal";
        soldModal.classList.add("modal", "hidden");
        soldModal.innerHTML = `
            <div class="modal-content">
                <span class="close-btn" id="close-sold-modal">&times;</span>
                <h3>Mark as Sold</h3>
                <form id="sold-form">
                    <label for="buyer-name">Buyer Name:</label>
                    <input type="text" id="buyer-name" placeholder="Enter buyer's name" required>

                    <label for="buyer-contact">Buyer Contact:</label>
                    <input type="text" id="buyer-contact" placeholder="Enter buyer's contact" required>

                    <label for="sold-date">Sale Date:</label>
                    <input type="date" id="sold-date" required>

                    <label for="sold-price">Sale Price ($):</label>
                    <input type="number" id="sold-price" placeholder="Enter sold price" required>

                    <label for="sold-details">Sale Details:</label>
                    <textarea id="sold-details" placeholder="Enter additional details" rows="4"></textarea>

                    <div class="button-container">
                        <button type="button" class="btn cancel-btn" id="cancel-sold">Cancel</button>
                        <button type="submit" class="btn confirm-btn">Confirm</button>
                    </div>
                </form>
            </div>
        `;
        document.body.appendChild(soldModal);

        // Modal Elements
        const closeSoldModal = document.getElementById("close-sold-modal");
        const cancelSoldBtn = document.getElementById("cancel-sold");
        const soldForm = document.getElementById("sold-form");

        let vehicleToMarkSoldId = null; // Track the vehicle to be marked as sold
        let vehicleToMarkSoldData = null; // Track the data of the vehicle

        // Mark as Sold: Open Modal
        function openMarkAsSoldModal(id, data) {
            vehicleToMarkSoldId = id;
            vehicleToMarkSoldData = data;
            soldModal.classList.remove("hidden");
        }

        // Close Sold Modal
        function closeSoldModalFn() {
            vehicleToMarkSoldId = null;
            vehicleToMarkSoldData = null;

            // Clear the fields in the modal
            document.getElementById("sold-price").value = "";
            document.getElementById("buyer-name").value = "";
            document.getElementById("buyer-contact").value = "";
            document.getElementById("sold-date").value = "";
            document.getElementById("sold-details").value = "";

            soldModal.classList.add("hidden");
        }

        closeSoldModal.addEventListener("click", closeSoldModalFn);
        cancelSoldBtn.addEventListener("click", closeSoldModalFn);

        // Handle Sold Form Submission
        soldForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            // Get values from the form
            const soldPrice = parseFloat(document.getElementById("sold-price").value.trim());
            const buyerName = document.getElementById("buyer-name").value.trim();
            const buyerContact = document.getElementById("buyer-contact").value.trim();
            const soldDate = document.getElementById("sold-date").value;
            const soldDetails = document.getElementById("sold-details").value.trim();

            if (!soldPrice || !buyerName || !buyerContact || !soldDate) {
                alert("Please fill in all required fields.");
                return;
            }

            try {
                // Create new document in the "sold" collection
                const soldData = {
                    ...vehicleToMarkSoldData,
                    soldPrice,
                    buyerName,
                    buyerContact,
                    soldDate: new Date(soldDate),
                    soldDetails,
                };

                const formData = {
                    ...vehicleToMarkSoldData,
                    formType: "sold-form",
                    soldPrice,
                    buyerName,
                    buyerContact,
                    soldDate: new Date(soldDate),
                    soldDetails,
                };

                const soldRef = collection(db, "sold");
                await addDoc(soldRef, soldData);
                const soldNum = collection(db, "new-forms");
                await addDoc(soldNum, formData);

                // Delete from "inventory"
                const vehicleDoc = doc(db, "inventory", vehicleToMarkSoldId);
                await deleteDoc(vehicleDoc);


                closeSoldModalFn();
            } catch (error) {
                console.error("Error marking vehicle as sold:", error);
            }
        });


        // Delete Vehicle
        function openDeleteConfirmationModal(id) {
            vehicleToDeleteId = id;
            deleteConfirmationModal.classList.remove('hidden');
        }
    
        cancelDeleteBtn.addEventListener('click', () => {
            vehicleToDeleteId = null;
            deleteConfirmationModal.classList.add('hidden');
        });
    
        confirmDeleteBtn.addEventListener('click', async () => {
            if (vehicleToDeleteId) {
                const vehicleDoc = doc(db, "inventory", vehicleToDeleteId);
                await deleteDoc(vehicleDoc);
                deleteConfirmationModal.classList.add('hidden');
            }
        });
    
        // Form Submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const mainPictureInput = document.getElementById('main-picture');
            const mainPicture = mainPictureInput.files[0];
            const secondaryPictures = Array.from(document.getElementById('secondary-pictures').files);

            let mainPictureUrl = null;
            const secondaryPicturesUrls = [...(currentEditData?.secondaryPicturesUrls || [])];

            try {
                showLoading();

                if (mode === "edit") {
                    // Use existing main picture or upload a new one
                    mainPictureUrl = currentEditData?.mainPictureUrl || null;

                    if (mainPicture) {
                        mainPictureUrl = await uploadImageToImgBB(mainPicture);
                    }
                } else if (mode === "add") {
                    // Ensure no leftover data is used for a new vehicle
                    currentEditData = null;

                    // Main picture is required for new vehicles
                    if (mainPicture) {
                        mainPictureUrl = await uploadImageToImgBB(mainPicture);
                    } else {
                        hideLoading();
                        return;
                    }
                }

                // Upload secondary pictures
                for (const file of secondaryPictures) {
                    const url = await uploadImageToImgBB(file);
                    if (url) secondaryPicturesUrls.push(url);
                }

        
                const vehicleData = {
                    make: document.getElementById('make').value.trim(),
                    model: document.getElementById('model').value.trim(),
                    year: document.getElementById('year').value.trim(),
                    price: parseInt(document.getElementById('price').value.trim(), 10),
                    premiumPrice: premiumToggle.checked ? premiumPriceInput.value.trim() : null,
                    fuelType: document.getElementById('fuel-type').value, // New field
                    driveTrain: document.getElementById('drive-train').value, // New field
                    doors: document.getElementById('doors').value.trim(), // New field
                    seats: document.getElementById('seats').value.trim(), // New field
                    interiorColor: document.getElementById('interior-color').value, // New field
                    description: descriptionTextarea.value.trim(), // Include description
                    bodyStyle: document.getElementById('body-style').value,
                    engine: document.getElementById('engine').value,
                    transmission: document.getElementById('transmission').value,
                    color: document.getElementById('color').value === 'other'
                        ? document.getElementById('other-color').value.trim()
                        : document.getElementById('color').value,
                    mileage: parseInt(document.getElementById('mileage').value.trim(), 10),
                    vin: document.getElementById('vin').value.trim(),
                    stock: document.getElementById('stock').value.trim(),
                    mainPictureUrl,
                    secondaryPicturesUrls,
                    timestamp: new Date(),
                    features: window.vehicleFeatures || {} // Add categorized features here

                };
    
                if (mode === "add") {
                    await addDoc(inventoryRef, vehicleData);
                } else if (mode === "edit" && currentEditId) {
                    const vehicleDoc = doc(db, "inventory", currentEditId);
                    await updateDoc(vehicleDoc, vehicleData);
                    alert('Vehicle updated successfully!');
                }
    
                form.reset();
                resetPremiumPriceField(); // Reset premium price field
                modal.classList.add('hidden');
            } catch (error) {
                console.error("Error saving vehicle:", error);
                alert("Failed to save vehicle. Please try again.");
            } finally {
                hideLoading();
            }
        });


        // Sort Popup Logic
        const sortIcon = document.getElementById("sort-icon");
        const sortPopup = document.getElementById("sort-popup");
        const closeSortPopup = document.getElementById("close-sort-popup");
        const applySortButton = document.getElementById("apply-sort");
    
        sortIcon.addEventListener("click", () => {
            sortPopup.classList.remove("hidden");
        });
    
        closeSortPopup.addEventListener("click", () => {
            sortPopup.classList.add("hidden");
        });
    
    
        // Search Functionality
        const searchInput = document.getElementById("search-input");
    
        searchInput.addEventListener("input", () => {
            const query = searchInput.value.toLowerCase();
            const rows = document.querySelectorAll("#inventory-list tbody tr");
    
            rows.forEach(row => {
                const make = row.children[1].textContent.toLowerCase();
                const model = row.children[2].textContent.toLowerCase();
                const year = row.children[3].textContent.toLowerCase();
    
                if (make.includes(query) || model.includes(query) || year.includes(query)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        });


    
        // Upload Images to ImgBB
        async function uploadImageToImgBB(file) {
            const apiKey = '114bba60769f2d7d7bc403a7f0343c37';
            const formData = new FormData();
            formData.append('image', file);
    
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
    
                if (result.success) {
                    return result.data.url;
                } else {
                    throw new Error('Image upload failed.');
                }
            } catch (error) {
                console.error('Error uploading image:', error);
                return null;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const menuIcon = document.getElementById('menu-icon');
            const navbar = document.querySelector('.navbar');

            if (menuIcon && navbar) {
                menuIcon.addEventListener('click', () => {
                    navbar.classList.toggle('active');
                });
            }
        });
    
        // Populate Inventory Table on Load
        populateInventoryTable();
    </script>    
        
</body>

</html>