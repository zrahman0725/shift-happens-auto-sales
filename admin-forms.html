<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="css/admin-dashboard.css">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico?">


    <style>
.search-bar {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
}

.search-bar select {
    padding: 0.75rem;
    border: 1px solid #ccc;
    border-radius: 25px;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.search-bar select:focus {
    border-color: #00796b;
    outline: none;
    box-shadow: 0 0 5px rgba(0, 121, 107, 0.5);
}


        .search-bar input {
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 25px;
            width: 50%;
            max-width: 400px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-bar input:focus {
            border-color: #00796b;
            outline: none;
            box-shadow: 0 0 5px rgba(0, 121, 107, 0.5);
        }

        .waivers-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
        }

        .dashboard-container {
            padding: 2rem;
            padding-top: 5rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .waiver-card {
            background-color: #b2dfdb;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .waiver-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .waiver-card h3 {
            margin-bottom: 0.5rem;
            font-size: 1.25rem;
        }

        .waiver-card p {
            margin: 0.25rem 0;
        }

        .waiver-card img {
            margin: 0.5rem 0;
        }

        .waiver-card .btn {
            background-color: #00796b;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9rem;
        }

        .waiver-card .btn:hover {
            background-color: #004d40;
        }

        /* Pagination styles */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 2rem 0;
            gap: 0.5rem;
        }

        .pagination .btn {
            background-color: #00796b;
            color: white;
            border: none;
            padding: 0.3rem 0.6rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9rem;
        }

        .pagination .btn:hover {
            background-color: #004d40;
        }


        .modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
    padding-top: 60px;
}

.modal-content {
    background-color: #000000;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 600px;
    border-radius: 8px;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
}

#form-details-content p {
    margin: 0.5rem 0;
}


        .modal h2 {
            margin-top: 0;
        }

        .modal p {
            margin: 0.5rem 0;
        }

        .waiver-card .btn.delete {
            background-color: #e53935;
        }

        .waiver-card .btn.delete:hover {
            background-color: #b71c1c;
        }

/* Finance Application - Soft Yellow */
.waiver-card.finance-application {
    background-color: #fff3b0; /* Darker Light Yellow */
    border-left: 5px solid #fbc02d; /* Golden Yellow */
    color: #000; /* Black Text */
}

/* Trade-In - Soft Green */
.waiver-card.trade-in {
    background-color: #dcedc8; /* Darker Light Green */
    border-left: 5px solid #388e3c; /* Medium Green */
    color: #000; /* Black Text */
}

/* Car Finder - Soft Blue */
.waiver-card.car-finder {
    background-color: #bbdefb; /* Darker Light Blue */
    border-left: 5px solid #1976d2; /* Medium Blue */
    color: #000; /* Black Text */
}

/* Contact Form - Soft Red */
.waiver-card.contact-form {
    background-color: #ffcdd2; /* Darker Light Red */
    border-left: 5px solid #d32f2f; /* Medium Red */
    color: #000; /* Black Text */
}

/* Test Drive - Soft Purple */
.waiver-card.test-drive {
    background-color: #e1bee7; /* Darker Light Purple */
    border-left: 5px solid #8e24aa; /* Medium Purple */
    color: #000; /* Black Text */
}

/* Hover Effect - Subtle Elevation */
.waiver-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Slightly bolder shadow */
}


    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <a href="index.html" class="logo"><img src="images/IMG-20241122-WA0003_1468205583269761 (1).png" alt="">Shift Happens Auto Sales</a>

        <i class='bx bx-menu' id="menu-icon"></i>

        <nav class="navbar">
            <a href="index.html#home" data-alt-link="home.html">Home</a>
            <div class="dropdown">
                <a href="inventory.html" data-alt-link="inventory.html">Inventory</a>
                <div class="dropdown-menu">
                    <a href="inventory.html">View Inventory</a>
                    <a href="car-finder.html">Car Finder</a>
                </div>
            </div>
            <div class="dropdown">
                <a href="finance.html" data-alt-link="finance.html">Finance</a>
                <div class="dropdown-menu">
                    <a href="finance-application.html">Finance Application</a>
                    <a href="finance.html">Finance Department</a>
                    <a href="finance.html#credit">Credit Tips</a>
                </div>
            </div>
            <div class="dropdown">
                <a href="services.html" data-alt-link="services.html">Services</a>
                <div class="dropdown-menu">
                    <a href="detailing.html">Detailing</a>
                    <a href="trade-in.html">Trade-ins</a>
                    <a href="test-drive.html">Test Drives</a>
                    <a href="car-loan.html">Loan Calculator</a>
                </div>
            </div>
            <div class="dropdown">
                <a href="about.html" data-alt-link="about.html">Dealership</a>
                <div class="dropdown-menu">
                    <a href="about.html">About Us</a>
                    <a href="index.html#contact-form">Contact</a>
                </div>
            </div>
        </nav>
        
        
    </header>

    <!-- Secondary Navbar -->
    <nav class="secondary-navbar">
        <a href="admin-dashboard.html">Dashboard</a>
        <a href="admin-inventory.html">Inventory</a>
        <a href="admin-forms.html" class="active">Forms</a>
        <a href="admin-users.html">Users</a>

    </nav>

    <section>
        <h2 class="heading">Forms <span>Submitted</span></h2>
    
        <div class="dashboard-container">
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Search by name or type...">
                <select id="form-filter">
                    <option value="all" selected>All</option>
                    <option value="new">New</option>
                    <option value="old">Old</option>
                </select>
            </div>
            
            
            <div class="waivers-grid" id="waivers-grid">
                <!-- Form cards will be inserted here -->
            </div>
        </div>
    
        <!-- Pagination Controls -->
        <div class="pagination">
            <button id="prev-page" class="btn">Previous</button>
            <span id="page-info"></span>
            <button id="next-page" class="btn">Next</button>
        </div>
    </section>
    

<!-- Form Details Modal -->
<div id="formDetailsModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeFormDetails()">&times;</span>
        <h2>Form Details</h2>
        <div id="form-details-content">
            <!-- Form details will be dynamically inserted here -->
        </div>
    </div>
</div>


<footer class="footer">
    <div class="footer-text">
        <p>Copyright &copy; 2024 by Shift Happens Auto Sales | All Rights Reserved. | <a href="admin-login.html">Admin</a> </p>
    </div>

    <div class="footer-iconTop">
        <a href="#"><i class='bx bx-up-arrow-alt'></i></a>
    </div>
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getFirestore, collection, doc, getDocs, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDv6Jkk-7XqeCMTy14Fjs_upMAjVM7uNVg",
        authDomain: "shift-happens-auto-sales.firebaseapp.com",
        projectId: "shift-happens-auto-sales",
        storageBucket: "shift-happens-auto-sales.appspot.com",
        messagingSenderId: "224158026936",
        appId: "1:224158026936:web:690dd13405f6b1bfc4b84d"
    };
    function updateFormSource() {
    filterForms();
}

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let newForms = [];
    let oldForms = [];
    let filteredForms = [];
    let currentPage = 1;
    const itemsPerPage = 9;

    // Fetch forms from new-forms collection
    async function fetchForms() {
        const formsCollection = collection(db, "new-forms");
        const formsSnapshot = await getDocs(formsCollection);
        newForms = formsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        console.log("Fetched forms from new-forms:", newForms);
    }

    // Fetch forms from old-forms collection
    async function fetchOldForms() {
        const formsCollection = collection(db, "old-forms");
        const formsSnapshot = await getDocs(formsCollection);
        oldForms = formsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        console.log("Fetched forms from old-forms:", oldForms);
    }

    // Render all forms in a single grid
    function renderAllForms() {
    const allFormsGrid = document.getElementById("waivers-grid");
    allFormsGrid.innerHTML = ""; // Clear the grid

    // Use filteredForms if available; otherwise, use all forms
    const formsToRender = filteredForms.length > 0 ? filteredForms : [...newForms, ...oldForms];

    formsToRender.forEach(form => {
        const card = document.createElement("div");
        card.className = `waiver-card ${form.formType}`;
        card.innerHTML = `
            <h3>${form.firstName || "Unknown"} - ${form.formType.toUpperCase()}</h3>
            <p><strong>Submitted By:</strong> ${form.firstName || "N/A"} ${form.lastName || ""}</p>
            <p><strong>Email:</strong> ${form.email || "N/A"}</p>
            <p><strong>Phone:</strong> ${form.phone || "N/A"}</p>
            <p><strong>Date:</strong> ${form.timestamp?.toDate().toLocaleString() || "N/A"}</p>
            <div class="buttons-container">
                <button class="btn" onclick="viewForm('${form.id}')">View Details</button>
                <button class="btn" onclick="downloadFormAsPDF('${form.id}')">Download PDF</button>
                ${
                    newForms.some(f => f.id === form.id)
                        ? `<button class="btn" onclick="markAsRead('${form.id}')">Mark as Read</button>`
                        : `
                            <button class="btn" onclick="markAsUnread('${form.id}')">Mark as Unread</button>
                            <button class="btn delete" onclick="deleteOldForm('${form.id}')">Delete Permanently</button>
                          `
                }
            </div>
        `;
        allFormsGrid.appendChild(card);
    });
}


    // Filter forms based on search or dropdown
    function filterForms() {
        const searchInput = document.getElementById("search-input").value.toLowerCase();
        const filter = document.getElementById("form-filter").value;

        const allForms = [...newForms, ...oldForms];
        filteredForms = allForms.filter(form => {
            const matchesSearch = searchInput
                ? form.firstName?.toLowerCase().includes(searchInput) ||
                  form.lastName?.toLowerCase().includes(searchInput) ||
                  form.formType?.toLowerCase().includes(searchInput)
                : true;

            const matchesFilter = filter === "all" ||
                (filter === "new" && newForms.some(f => f.id === form.id)) ||
                (filter === "old" && oldForms.some(f => f.id === form.id));

            return matchesSearch && matchesFilter;
        });

        renderAllForms();
    }

    // View form details in a modal
    window.viewForm = function (formId) {
        const forms = [...newForms, ...oldForms];
        const form = forms.find(f => f.id === formId);
        if (form) {
            const modalContent = document.getElementById("form-details-content");
            modalContent.innerHTML = `
                <p><strong>Form Type:</strong> ${form.formType.toUpperCase()}</p>
                <p><strong>Submitted By:</strong> ${form.firstName || form.name || "N/A"} ${form.lastName || ""}</p>
                <p><strong>Email:</strong> ${form.email || "N/A"}</p>
                <p><strong>Phone:</strong> ${form.phone || form.mobile || "N/A"}</p>
                <p><strong>Date:</strong> ${form.timestamp?.toDate().toLocaleString() || "N/A"}</p>
            `;

            // Add additional form-specific details dynamically
            if (form.formType === "finance-application") {
                modalContent.innerHTML += `
                    <p><strong>Address:</strong> ${form.address || "N/A"}</p>
                    <p><strong>Monthly Payment:</strong> ${form.monthlyPayment || "N/A"}</p>
                `;
            } else if (form.formType === "trade-in") {
                modalContent.innerHTML += `
                    <p><strong>Vehicle Make:</strong> ${form.vehicle?.make || "N/A"}</p>
                    <p><strong>Vehicle Model:</strong> ${form.vehicle?.model || "N/A"}</p>
                    <p><strong>Year:</strong> ${form.vehicle?.year || "N/A"}</p>
                `;
            } else if (form.formType === "car-finder") {
                modalContent.innerHTML += `
                    <p><strong>Preferred Make:</strong> ${form.vehiclePreferences?.make || "N/A"}</p>
                    <p><strong>Budget:</strong> ${form.vehiclePreferences?.budget || "N/A"}</p>
                `;
            } else if (form.formType === "test-drive") {
                modalContent.innerHTML += `
                    <p><strong>Selected Vehicle:</strong> ${form.selectedVehicle || "N/A"}</p>
                    <p><strong>Availability:</strong> ${form.availability?.map(a => `${a.day}: ${a.times.join(", ")}`).join("<br>") || "N/A"}</p>
                `;
            }

            document.getElementById("formDetailsModal").style.display = "block";
        }
    };

    window.closeFormDetails = function () {
        document.getElementById("formDetailsModal").style.display = "none";
    };

    // Download form as PDF
    window.downloadFormAsPDF = function (formId) {
        const forms = [...newForms, ...oldForms];
        const form = forms.find(f => f.id === formId);
        if (form) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Add content to the PDF
            doc.text(`Form Type: ${form.formType.toUpperCase()}`, 10, 10);
            doc.text(`Submitted By: ${form.firstName || form.name || "N/A"} ${form.lastName || ""}`, 10, 20);
            doc.text(`Email: ${form.email || "N/A"}`, 10, 30);
            doc.text(`Phone: ${form.phone || form.mobile || "N/A"}`, 10, 40);
            doc.text(`Date: ${form.timestamp?.toDate().toLocaleString() || "N/A"}`, 10, 50);

            // Save the PDF
            doc.save(`${form.formType}-${form.firstName || form.name || "Unknown"}.pdf`);
        }
    };
    // Pagination controls
    document.getElementById("prev-page").addEventListener("click", () => {
        if (currentPage > 1) {
            currentPage--;
            renderForms();
        }
    });

    document.getElementById("next-page").addEventListener("click", () => {
        if (currentPage * itemsPerPage < filteredForms.length) {
            currentPage++;
            renderForms();
        }
    });




    // Mark a form as read and move to old-forms
    window.markAsRead = async function (formId) {
        const form = newForms.find(f => f.id === formId);
        if (!form) {
            console.error("Form not found in newForms array for formId:", formId);
            return;
        }

        try {
            const oldFormsCollection = collection(db, "old-forms");

            const { id, ...formData } = form;
            await addDoc(oldFormsCollection, formData);

            const formDoc = doc(db, "new-forms", formId);
            await deleteDoc(formDoc);

            await fetchForms();
            await fetchOldForms();
            renderAllForms();
        } catch (error) {
            console.error("Error marking form as read:", error);
        }
    };

    // Mark a form as unread and move to new-forms
    window.markAsUnread = async function (formId) {
        const form = oldForms.find(f => f.id === formId);
        if (!form) {
            console.error("Form not found in oldForms array for formId:", formId);
            return;
        }

        try {
            const newFormsCollection = collection(db, "new-forms");

            const { id, ...formData } = form;
            await addDoc(newFormsCollection, formData);

            const formDoc = doc(db, "old-forms", formId);
            await deleteDoc(formDoc);

            await fetchForms();
            await fetchOldForms();
            renderAllForms();
        } catch (error) {
            console.error("Error marking form as unread:", error);
        }
    };

    // Delete a form permanently from old-forms
    window.deleteOldForm = async function (formId) {
        if (confirm("Are you sure you want to delete this form? This action cannot be undone.")) {
            try {
                const formDoc = doc(db, "old-forms", formId);
                await deleteDoc(formDoc);

                alert("Form deleted successfully.");
                await fetchOldForms();
                renderAllForms();
            } catch (error) {
                console.error("Error deleting old form:", error);
                alert("An error occurred while deleting the form.");
            }
        }
    };


    // Initialize
    document.addEventListener("DOMContentLoaded", async () => {
    await fetchForms();
    await fetchOldForms();
    renderAllForms();

    document.getElementById("search-input").addEventListener("input", filterForms);
    document.getElementById("form-filter").addEventListener("change", filterForms);
});


</script>


    
        <script>
        // Toggle Navbar
        document.addEventListener('DOMContentLoaded', () => {
    let menuIcon = document.querySelector('#menu-icon');
    let navbar = document.querySelector('.navbar');

    if (menuIcon && navbar) {
        menuIcon.onclick = () => {
            menuIcon.classList.toggle('bx-x');
            navbar.classList.toggle('active');
        };
    }
});
</script>
   
</body>

</html>
